<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Giorgia Cecchinato, gcecchinato@worldbank.org">

<title>Accessing poverty and inequality data from the World Bank in R</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="R_part_2_files/libs/clipboard/clipboard.min.js"></script>
<script src="R_part_2_files/libs/quarto-html/quarto.js"></script>
<script src="R_part_2_files/libs/quarto-html/popper.min.js"></script>
<script src="R_part_2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="R_part_2_files/libs/quarto-html/anchor.min.js"></script>
<link href="R_part_2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="R_part_2_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="R_part_2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="R_part_2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="R_part_2_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">1</span> Introduction</a></li>
  <li><a href="#replicate-pip-data-for-nigeria-survey-years" id="toc-replicate-pip-data-for-nigeria-survey-years" class="nav-link" data-scroll-target="#replicate-pip-data-for-nigeria-survey-years"><span class="header-section-number">2</span> Replicate PIP Data for Nigeria (Survey Years)</a>
  <ul class="collapse">
  <li><a href="#version-1-using-percentiles" id="toc-version-1-using-percentiles" class="nav-link" data-scroll-target="#version-1-using-percentiles"><span class="header-section-number">2.1</span> Version 1: Using percentiles</a></li>
  <li><a href="#version-2-using-actual-microdata" id="toc-version-2-using-actual-microdata" class="nav-link" data-scroll-target="#version-2-using-actual-microdata"><span class="header-section-number">2.2</span> Version 2: using actual microdata</a></li>
  </ul></li>
  <li><a href="#replicate-pip-data-for-nigeria-reference-years" id="toc-replicate-pip-data-for-nigeria-reference-years" class="nav-link" data-scroll-target="#replicate-pip-data-for-nigeria-reference-years"><span class="header-section-number">3</span> Replicate PIP Data for Nigeria (Reference Years)</a>
  <ul class="collapse">
  <li><a href="#get-survey-years-estimates" id="toc-get-survey-years-estimates" class="nav-link" data-scroll-target="#get-survey-years-estimates"><span class="header-section-number">3.1</span> Get survey years estimates</a></li>
  <li><a href="#get-interpolated-means" id="toc-get-interpolated-means" class="nav-link" data-scroll-target="#get-interpolated-means"><span class="header-section-number">3.2</span> Get interpolated means</a></li>
  <li><a href="#calculate-interpolated-values" id="toc-calculate-interpolated-values" class="nav-link" data-scroll-target="#calculate-interpolated-values"><span class="header-section-number">3.3</span> Calculate interpolated values</a></li>
  </ul></li>
  <li><a href="#estimate-global-and-regional-poverty" id="toc-estimate-global-and-regional-poverty" class="nav-link" data-scroll-target="#estimate-global-and-regional-poverty"><span class="header-section-number">4</span> Estimate Global and Regional Poverty</a>
  <ul class="collapse">
  <li><a href="#get-population-data-and-country-reference-table" id="toc-get-population-data-and-country-reference-table" class="nav-link" data-scroll-target="#get-population-data-and-country-reference-table"><span class="header-section-number">4.1</span> Get Population Data and Country Reference Table</a></li>
  <li><a href="#obtain-reference-year-poverty-estimates-and-merge" id="toc-obtain-reference-year-poverty-estimates-and-merge" class="nav-link" data-scroll-target="#obtain-reference-year-poverty-estimates-and-merge"><span class="header-section-number">4.2</span> Obtain reference-year poverty estimates and Merge</a></li>
  <li><a href="#get-africa-split-codes-for-afw-and-afe-and-append" id="toc-get-africa-split-codes-for-afw-and-afe-and-append" class="nav-link" data-scroll-target="#get-africa-split-codes-for-afw-and-afe-and-append"><span class="header-section-number">4.3</span> Get Africa Split Codes for AFW and AFE and Append</a></li>
  <li><a href="#calculate-global-poverty-estimates" id="toc-calculate-global-poverty-estimates" class="nav-link" data-scroll-target="#calculate-global-poverty-estimates"><span class="header-section-number">4.4</span> Calculate Global Poverty Estimates</a></li>
  <li><a href="#compare-with-already-calculated-regioal-aggregates" id="toc-compare-with-already-calculated-regioal-aggregates" class="nav-link" data-scroll-target="#compare-with-already-calculated-regioal-aggregates"><span class="header-section-number">4.5</span> Compare with already calculated regioal aggregates</a></li>
  </ul></li>
  <li><a href="#calculate-the-international-poverty-line" id="toc-calculate-the-international-poverty-line" class="nav-link" data-scroll-target="#calculate-the-international-poverty-line"><span class="header-section-number">5</span> Calculate the international poverty line</a>
  <ul class="collapse">
  <li><a href="#load-data-and-query-pip" id="toc-load-data-and-query-pip" class="nav-link" data-scroll-target="#load-data-and-query-pip"><span class="header-section-number">5.1</span> Load Data and query PIP</a></li>
  <li><a href="#calculate-the-international-poverty-line-ipl" id="toc-calculate-the-international-poverty-line-ipl" class="nav-link" data-scroll-target="#calculate-the-international-poverty-line-ipl"><span class="header-section-number">5.2</span> Calculate the International Poverty Line (IPL)</a></li>
  <li><a href="#visualize-harmonized-poverty-lines-by-region" id="toc-visualize-harmonized-poverty-lines-by-region" class="nav-link" data-scroll-target="#visualize-harmonized-poverty-lines-by-region"><span class="header-section-number">5.3</span> Visualize Harmonized Poverty Lines by Region</a></li>
  </ul></li>
  <li><a href="#exercise-1-kuznets-curve" id="toc-exercise-1-kuznets-curve" class="nav-link" data-scroll-target="#exercise-1-kuznets-curve"><span class="header-section-number">6</span> Exercise 1: Kuznets Curve</a>
  <ul class="collapse">
  <li><a href="#scatterplot" id="toc-scatterplot" class="nav-link" data-scroll-target="#scatterplot"><span class="header-section-number">6.1</span> Scatterplot</a></li>
  <li><a href="#regression-check" id="toc-regression-check" class="nav-link" data-scroll-target="#regression-check"><span class="header-section-number">6.2</span> Regression Check</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">6.3</span> Conclusion</a></li>
  </ul></li>
  <li><a href="#exercise-2-covid-19-impact-on-poverty-and-inequality" id="toc-exercise-2-covid-19-impact-on-poverty-and-inequality" class="nav-link" data-scroll-target="#exercise-2-covid-19-impact-on-poverty-and-inequality"><span class="header-section-number">7</span> Exercise 2: COVID-19 Impact on poverty and inequality</a>
  <ul class="collapse">
  <li><a href="#change-in-millions-of-extreme-poor" id="toc-change-in-millions-of-extreme-poor" class="nav-link" data-scroll-target="#change-in-millions-of-extreme-poor"><span class="header-section-number">7.1</span> Change in Millions of Extreme Poor</a></li>
  <li><a href="#change-in-gini-coefficient" id="toc-change-in-gini-coefficient" class="nav-link" data-scroll-target="#change-in-gini-coefficient"><span class="header-section-number">7.2</span> Change in Gini Coefficient</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Accessing poverty and inequality data from the World Bank in R</h1>
<p class="subtitle lead">Part 2</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Giorgia Cecchinato, gcecchinato@worldbank.org </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<p><strong>Set-up</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pipr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># library(joyn) # not necessary, but nice features, and developed by our own team!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>The <strong>objectives</strong> of this session are to:</p>
<ol type="1">
<li>Learn how PIP data are actually calculated by replicating them (Nigeria).</li>
</ol>
<ul>
<li><strong>Replication of survey years</strong> using percentiles and microdata.</li>
<li><strong>Replication of reference years</strong> (interpolation).</li>
<li>Calculate the <strong>international poverty line</strong>.</li>
</ul>
<ol start="2" type="1">
<li>Explore the data through some visualizations.</li>
</ol>
<ul>
<li>Kuznets curve.</li>
<li>COVID-19 impacts.</li>
</ul>
</section>
<section id="replicate-pip-data-for-nigeria-survey-years" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Replicate PIP Data for Nigeria (Survey Years)</h1>
<p>First we load the target values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>nga_hc <span class="ot">&lt;-</span> <span class="fu">get_stats</span>(<span class="at">country =</span> <span class="st">"NGA"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, year, headcount) <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">hc_pip =</span> headcount)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Pruning cache</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>nga_hc <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [8 × 3] (S3: tbl_df/tbl/data.frame)
 $ country_code: chr [1:8] "NGA" "NGA" "NGA" "NGA" ...
 $ year        : num [1:8] 1985 1992 1996 2003 2010 ...
 $ hc_pip      : num [1:8] 0.478 0.524 0.584 0.479 0.349 ...</code></pre>
</div>
</div>
<section id="version-1-using-percentiles" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="version-1-using-percentiles"><span class="header-section-number">2.1</span> Version 1: Using percentiles</h2>
<p>Microdata are not available for the public to download. They are only available for you to browse: <a href="https://pip.worldbank.org/sol/sol-landing">Microdata browsing</a>.</p>
<p>Instead, we provide access to country-level percentile data for the survey years.</p>
<p>How to access percentile data for the survey years:</p>
<ol type="1">
<li><p>Go to https://pip.worldbank.org/home</p></li>
<li><p>Go to Further Indicators &amp; Data</p></li>
<li><p>Go to Percentiles (<a href="https://datacatalog.worldbank.org/search/dataset/0063646">Datacatalog Percentiles</a>)</p></li>
<li><p>Download percentile data expressed in 2017 PPP dollars for the survey years.</p></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>world_100bin <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"/Users/giorgia/repos/pip_canazei_notes/material/world_100bin.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 245592 Columns: 10
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (3): country_code, reporting_level, welfare_type
dbl (7): year, percentile, avg_welfare, pop_share, welfare_share, quantile, pop

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>nga_100bin <span class="ot">&lt;-</span> world_100bin <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country_code <span class="sc">==</span> <span class="st">"NGA"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, year, percentile, avg_welfare, pop_share) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(year, percentile) <span class="sc">|&gt;</span> <span class="co"># just to make sure</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">poor =</span> avg_welfare <span class="sc">&lt;</span> <span class="fl">2.15</span>) <span class="sc">|&gt;</span> <span class="co"># Deault poverty line is always 2.15</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(country_code, year) <span class="sc">|&gt;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">hc_own =</span> <span class="fu">weighted.mean</span>(poor, <span class="at">w =</span> pop_share, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'country_code'. You can override using the
`.groups` argument.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>nga_100bin <span class="sc">|&gt;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(nga_hc, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country_code"</span>, <span class="st">"year"</span>))<span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d_hc =</span> <span class="fu">round</span>(hc_pip<span class="sc">/</span>hc_own))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 5
# Groups:   country_code [1]
  country_code  year hc_own hc_pip  d_hc
  &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 NGA           1985  0.480  0.478     1
2 NGA           1992  0.520  0.524     1
3 NGA           1996  0.580  0.584     1
4 NGA           2003  0.480  0.479     1
5 NGA           2010  0.350  0.349     1
6 NGA           2012  0.340  0.338     1
7 NGA           2015  0.320  0.323     1
8 NGA           2018  0.310  0.309     1</code></pre>
</div>
</div>
</section>
<section id="version-2-using-actual-microdata" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="version-2-using-actual-microdata"><span class="header-section-number">2.2</span> Version 2: using actual microdata</h2>
<p>First, we need to get auxiliary data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CPI</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>cpi_tables <span class="ot">&lt;-</span> <span class="fu">get_aux</span>(<span class="st">"cpi"</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">cpi =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, year, cpi) <span class="sc">|&gt;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country_code <span class="sc">==</span> <span class="st">"NGA"</span>, year <span class="sc">==</span> <span class="dv">2018</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># PPP data</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>ppp_tables <span class="ot">&lt;-</span> <span class="fu">get_aux</span>(<span class="st">"ppp"</span>) <span class="sc">|&gt;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">ppp =</span> value) <span class="sc">|&gt;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, year, ppp) <span class="sc">|&gt;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country_code <span class="sc">==</span> <span class="st">"NGA"</span>, year <span class="sc">==</span> <span class="dv">2017</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we load the microdata:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(haven)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>nga2018 <span class="ot">&lt;-</span> <span class="fu">read_dta</span>(<span class="st">"/Users/giorgia/repos/pip_canazei_notes/material/NGA2018.dta"</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>nga2018 <span class="sc">|&gt;</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="at">n=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 13
   year   hhid welfare weight urban     hsize country_code surveyid     rep_year
  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl+lbl&gt; &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;           &lt;dbl&gt;
1  2018 101001 257791.  1799. 1 [Urban]     6 NGA          NGA_2018_LSS     2018
2  2018 101001 257791.  1799. 1 [Urban]     6 NGA          NGA_2018_LSS     2018
3  2018 101001 257791.  1799. 1 [Urban]     6 NGA          NGA_2018_LSS     2018
4  2018 101001 257791.  1799. 1 [Urban]     6 NGA          NGA_2018_LSS     2018
5  2018 101001 257791.  1799. 1 [Urban]     6 NGA          NGA_2018_LSS     2018
# ℹ 4 more variables: ref_year &lt;dbl&gt;, svyyear &lt;dbl&gt;, reporting_level &lt;chr&gt;,
#   welfare_type &lt;chr&gt;</code></pre>
</div>
</div>
<p>Merge with <code>cpi_tables</code> and <code>ppp_tables</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>nga2018 <span class="ot">&lt;-</span> nga2018 <span class="sc">|&gt;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(cpi_tables, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country_code"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(ppp_tables, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country_code"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>nga2018_hc_own <span class="ot">&lt;-</span> nga2018 <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, welfare, cpi, ppp, weight, year) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">welf_ppp =</span> welfare <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>cpi) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span>ppp) <span class="sc">*</span> (<span class="dv">1</span><span class="sc">/</span><span class="dv">365</span>)) <span class="sc">|&gt;</span> <span class="co"># daily p.c. PPP terms</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">poor =</span> welf_ppp <span class="sc">&lt;=</span> <span class="fl">2.15</span>) <span class="sc">|&gt;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(country_code, year) <span class="sc">|&gt;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">hc_own =</span> <span class="fu">weighted.mean</span>(poor, <span class="at">w =</span> weight))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'country_code'. You can override using the
`.groups` argument.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>nga2018_hc_own</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
# Groups:   country_code [1]
  country_code year  hc_own
  &lt;chr&gt;        &lt;fct&gt;  &lt;dbl&gt;
1 NGA          2017   0.309</code></pre>
</div>
</div>
</section>
</section>
<section id="replicate-pip-data-for-nigeria-reference-years" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Replicate PIP Data for Nigeria (Reference Years)</h1>
<p>In part 1 we looked at the difference between survey year estimates and reference year estimates, as well as the difference between <code>fill_gaps = TRUE</code> and <code>nowcast = TRUE</code>. Now, we are going to go through a replication of PIP data for reference years for Nigeria.</p>
<p>To do so, we need to:</p>
<ol type="1">
<li><p>Get survey years estimates.</p></li>
<li><p>Calculate welfare means for reference years.</p></li>
<li><p>Calculate poverty headcount estimates based on welfare means for reference years.</p></li>
</ol>
<section id="get-survey-years-estimates" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="get-survey-years-estimates"><span class="header-section-number">3.1</span> Get survey years estimates</h2>
<p>Survey estimates are accessed as usual with <code>get_stats()</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>nga_pip <span class="ot">&lt;-</span> <span class="fu">get_stats</span>(<span class="at">country =</span> <span class="st">"NGA"</span>, <span class="co"># note that we are not filling gaps</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">reporting_level =</span> <span class="st">"national"</span>) <span class="sc">|&gt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">select</span>(country_code, <span class="at">wt =</span> welfare_time, mean)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nga_pip)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  country_code    wt  mean
  &lt;chr&gt;        &lt;dbl&gt; &lt;dbl&gt;
1 NGA          1985.  2.90
2 NGA          1992   2.86
3 NGA          1996.  2.92
4 NGA          2004.  2.92
5 NGA          2010.  3.50
6 NGA          2012.  3.55</code></pre>
</div>
</div>
<p>Note that welfare time is expressed in a decimal form, e.g.&nbsp;2015.5 for a survey conducted in the middle of 2015.</p>
</section>
<section id="get-interpolated-means" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="get-interpolated-means"><span class="header-section-number">3.2</span> Get interpolated means</h2>
<p>Welfare means are already calculated for us following the methodology described in the <a href="https://datanalytics.worldbank.org/PIP-Methodology/lineupestimates.html#interpolations">PIP methodology handbook</a>. We can access them using the function <code>get_aux("interpolated_means")</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>means_table <span class="ot">&lt;-</span> <span class="fu">get_aux</span>(<span class="st">"interpolated_means"</span>) <span class="sc">|&gt;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, year, welfare_time, welfare_type, survey_time, predicted_mean_ppp) <span class="sc">|&gt;</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(country_code <span class="sc">==</span> <span class="st">"NGA"</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(means_table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [76 × 6] (S3: tbl_df/tbl/data.frame)
 $ country_code      : chr [1:76] "NGA" "NGA" "NGA" "NGA" ...
 $ year              : num [1:76] 1981 1982 1983 1984 1985 ...
 $ welfare_time      : num [1:76] 1985 1985 1985 1985 1985 ...
 $ welfare_type      : chr [1:76] "consumption" "consumption" "consumption" "consumption" ...
 $ survey_time       : chr [1:76] "1985-1986" "1985-1986" "1985-1986" "1985-1986" ...
 $ predicted_mean_ppp: num [1:76] 3.45 3.22 2.92 2.85 2.91 ...</code></pre>
</div>
</div>
</section>
<section id="calculate-interpolated-values" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="calculate-interpolated-values"><span class="header-section-number">3.3</span> Calculate interpolated values</h2>
<p>Next, we need to calculate interpolated values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First we merge the interpolated means with survey estimates</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>merged_data <span class="ot">&lt;-</span> means_table <span class="sc">|&gt;</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(nga_pip, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country_code"</span>, <span class="st">"welfare_time"</span> <span class="ot">=</span> <span class="st">"wt"</span>))</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>merged_data <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="at">n=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 7
  country_code  year welfare_time welfare_type survey_time predicted_mean_ppp
  &lt;chr&gt;        &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;                    &lt;dbl&gt;
1 NGA           1981        1985. consumption  1985-1986                 3.45
2 NGA           1982        1985. consumption  1985-1986                 3.22
3 NGA           1983        1985. consumption  1985-1986                 2.92
4 NGA           1984        1985. consumption  1985-1986                 2.85
5 NGA           1985        1985. consumption  1985-1986                 2.91
# ℹ 1 more variable: mean &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Then, we need to:</p>
<ol type="1">
<li>Scale the adjusted poverty line, using the ratio between the survey <code>mean</code> and the <code>predicted_mean_ppp</code> (instead of adjusting the whole distribution).</li>
<li>Calculate interpolation weights based on the distance between the <code>welfare_time</code> and the reference <code>year.</code></li>
<li>Normalize the interpolation weights (calculate <code>interpolation_shr.</code></li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>merged_data_step1 <span class="ot">&lt;-</span> merged_data <span class="sc">|&gt;</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pl_to_query =</span> <span class="fl">2.15</span> <span class="sc">*</span> mean <span class="sc">/</span> predicted_mean_ppp) <span class="sc">|&gt;</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(pl_to_query)) </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  country_code  year welfare_time welfare_type survey_time predicted_mean_ppp
  &lt;chr&gt;        &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;                    &lt;dbl&gt;
1 NGA           1981        1985. consumption  1985-1986                 3.45
2 NGA           1982        1985. consumption  1985-1986                 3.22
3 NGA           1983        1985. consumption  1985-1986                 2.92
4 NGA           1984        1985. consumption  1985-1986                 2.85
5 NGA           1985        1985. consumption  1985-1986                 2.91
6 NGA           1986        1985. consumption  1985-1986                 2.86
# ℹ 1 more variable: mean &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>merged_data_step2 <span class="ot">&lt;-</span> merged_data_step1 <span class="sc">|&gt;</span> </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span>  </span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">interpol_wt =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">abs</span>(welfare_time <span class="sc">-</span> year), <span class="co"># Raw weights based on distance</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">interpol_wtt =</span> <span class="fu">sum</span>(interpol_wt, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="co"># Total weights within group</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">interpol_shr =</span> interpol_wt <span class="sc">/</span> interpol_wtt, <span class="co"># Normalized weights</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">survey_year =</span> <span class="fu">floor</span>(welfare_time) <span class="co"># Survey year as integer</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> <span class="co"># Ungroup for further processing</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(country_code, year, welfare_time)</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(merged_data_step2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 12
  country_code  year welfare_time welfare_type survey_time predicted_mean_ppp
  &lt;chr&gt;        &lt;dbl&gt;        &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;                    &lt;dbl&gt;
1 NGA           1981        1985. consumption  1985-1986                 3.45
2 NGA           1982        1985. consumption  1985-1986                 3.22
3 NGA           1983        1985. consumption  1985-1986                 2.92
4 NGA           1984        1985. consumption  1985-1986                 2.85
5 NGA           1985        1985. consumption  1985-1986                 2.91
6 NGA           1986        1985. consumption  1985-1986                 2.86
# ℹ 6 more variables: mean &lt;dbl&gt;, pl_to_query &lt;dbl&gt;, interpol_wt &lt;dbl&gt;,
#   interpol_wtt &lt;dbl&gt;, interpol_shr &lt;dbl&gt;, survey_year &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Finally we are ready for the poverty headcount estimation, which we’ll do in two steps:</p>
<p>First, we use <code>get_stats()</code> to calculate the new poverty headcount at each scaled poverty line (<code>pl_to_query</code>), and at each <code>survey_year.</code> For this exercise you can loop through the values, use <code>rowwise()</code> operations, or use <code>purrr</code> like we did here:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>merged_data_step3 <span class="ot">&lt;-</span> merged_data_step2 <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="dv">2015</span><span class="sc">:</span><span class="dv">2020</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>pl_queries <span class="ot">&lt;-</span> merged_data_step3 <span class="sc">|&gt;</span> </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">hc =</span> purrr<span class="sc">::</span><span class="fu">map2_dbl</span>(</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> survey_year,</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">.y =</span> pl_to_query,</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>      <span class="sc">~</span> <span class="fu">get_stats</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">country =</span> <span class="st">"NGA"</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">reporting_level =</span> <span class="st">"national"</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">year =</span> .x,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">povline =</span> .y</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>      )<span class="sc">$</span>headcount[<span class="dv">1</span>]</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>pl_queries <span class="sc">|&gt;</span> <span class="fu">select</span>(year, welfare_time, survey_year, pl_to_query, hc) <span class="sc">|&gt;</span> <span class="fu">str</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [10 × 5] (S3: tbl_df/tbl/data.frame)
 $ year        : num [1:10] 2015 2015 2016 2016 2017 ...
 $ welfare_time: num [1:10] 2012 2016 2016 2019 2016 ...
 $ survey_year : num [1:10] 2012 2015 2015 2018 2015 ...
 $ pl_to_query : num [1:10] 2.07 2.12 2.16 2.14 2.16 ...
 $ hc          : num [1:10] 0.316 0.315 0.324 0.308 0.325 ...</code></pre>
</div>
</div>
<p>Then, we calculate the weighted average of those headcounts estimates <code>hc</code> based on the share of the time (<code>interpolated_shr</code>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>nga_final_estimates <span class="ot">&lt;-</span> pl_queries <span class="sc">|&gt;</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">|&gt;</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">hc =</span> <span class="fu">weighted.mean</span>(hc, interpol_shr, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(nga_final_estimates)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tibble [6 × 2] (S3: tbl_df/tbl/data.frame)
 $ year: num [1:6] 2015 2016 2017 2018 2019 ...
 $ hc  : num [1:6] 0.315 0.322 0.317 0.312 0.309 ...</code></pre>
</div>
</div>
<p>And we check the results:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>nga_pip_fillgaps <span class="ot">&lt;-</span> <span class="fu">get_stats</span>(<span class="at">country =</span> <span class="st">"NGA"</span>, <span class="co"># note that we are not filling gaps</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">reporting_level =</span> <span class="st">"national"</span>) <span class="sc">|&gt;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">select</span>(country_code, year, <span class="at">hc_target =</span> headcount) <span class="co"># year is = reference year!</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>nga_final_estimates <span class="sc">|&gt;</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(nga_pip_fillgaps, <span class="at">by=</span><span class="fu">c</span>(<span class="st">'year'</span>))<span class="sc">|&gt;</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d_hc =</span> hc_target<span class="sc">/</span>hc)<span class="sc">|&gt;</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summary</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      year            hc         country_code         hc_target     
 Min.   :2015   Min.   :0.3091   Length:6           Min.   :0.3086  
 1st Qu.:2016   1st Qu.:0.3130   Class :character   1st Qu.:0.3121  
 Median :2018   Median :0.3162   Mode  :character   Median :0.3156  
 Mean   :2018   Mean   :0.3168                      Mean   :0.3156  
 3rd Qu.:2019   3rd Qu.:0.3206                      3rd Qu.:0.3191  
 Max.   :2020   Max.   :0.3254                      Max.   :0.3226  
                                                    NA's   :4       
      d_hc       
 Min.   :0.9881  
 1st Qu.:0.9971  
 Median :1.0062  
 Mean   :1.0062  
 3rd Qu.:1.0152  
 Max.   :1.0242  
 NA's   :4       </code></pre>
</div>
</div>
</section>
</section>
<section id="estimate-global-and-regional-poverty" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Estimate Global and Regional Poverty</h1>
<p>In Part 1, we looked at the function <code>get_wb()</code>, which gives you access to regional and global estimates of poverty and inequality metrics.</p>
<p>In this session, we will look at how exactly those numbers are calculated using country-level data and auxiliary tables (accessed with <code>get_aux()</code>).</p>
<p>Before starting, let’s have another look at the regional estimates available in PIP, and for which regions we need to calculate it:</p>
<p>However, there is not a one-to-one correspondence between the regions in the regional estimates and the regions in the country-level data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>pip_regional <span class="ot">&lt;-</span> <span class="fu">get_wb</span>()</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>pip_regional <span class="sc">|&gt;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(region_code, region_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 2
   region_code region_name                
   &lt;chr&gt;       &lt;chr&gt;                      
 1 AFE         Eastern and Southern Africa
 2 AFW         Western and Central Africa 
 3 EAP         East Asia &amp; Pacific        
 4 ECA         Europe &amp; Central Asia      
 5 LAC         Latin America &amp; Caribbean  
 6 MNA         Middle East &amp; North Africa 
 7 OHI         Other High Income Countries
 8 SAS         South Asia                 
 9 SSA         Sub-Saharan Africa         
10 WLD         World                      </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>country_estimates <span class="ot">&lt;-</span> <span class="fu">get_stats</span>(<span class="at">fill_gaps =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>country_estimates <span class="sc">|&gt;</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(region_code, region_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 2
  region_code region_name                
  &lt;chr&gt;       &lt;chr&gt;                      
1 SSA         Sub-Saharan Africa         
2 ECA         Europe &amp; Central Asia      
3 OHI         Other High Income Countries
4 LAC         Latin America &amp; Caribbean  
5 SAS         South Asia                 
6 EAP         East Asia &amp; Pacific        
7 MNA         Middle East &amp; North Africa </code></pre>
</div>
</div>
<p>We will need to calculate regional estimates for Eastern and Southern Africa (AFE) and Western and Central Africa (AFW) separately.</p>
<section id="get-population-data-and-country-reference-table" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="get-population-data-and-country-reference-table"><span class="header-section-number">4.1</span> Get Population Data and Country Reference Table</h2>
<p>You can use the function <code>get_aux()</code> to access population data for each country in PIP. We only need national level estimates, so we filter the data accordingly (and we keep Argentina, which is calculated based on urban population).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>pop_tables <span class="ot">&lt;-</span> </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">get_aux</span>(<span class="st">"pop"</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(data_level <span class="sc">==</span> <span class="st">"national"</span> <span class="sc">|</span> country_code <span class="sc">==</span> <span class="st">"ARG"</span>) <span class="sc">|&gt;</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">pop =</span> value, <span class="at">reporting_level =</span> data_level) <span class="sc">|&gt;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1990</span><span class="sc">:</span><span class="dv">2022</span>)) <span class="sc">|&gt;</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(year)))</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>pop_tables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,260 × 4
   country_code reporting_level  year   pop
   &lt;chr&gt;        &lt;chr&gt;           &lt;dbl&gt; &lt;dbl&gt;
 1 ABW          national         1990 65712
 2 ABW          national         1991 67864
 3 ABW          national         1992 70192
 4 ABW          national         1993 72360
 5 ABW          national         1994 74710
 6 ABW          national         1995 77050
 7 ABW          national         1996 79417
 8 ABW          national         1997 81858
 9 ABW          national         1998 84355
10 ABW          national         1999 86867
# ℹ 7,250 more rows</code></pre>
</div>
</div>
<p>Data are now identified uniquely by <code>country_code</code>, <code>year</code>, and <code>data_level</code>.</p>
<p>We get additional country-level reference table to match country codes with regions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>country_tables <span class="ot">&lt;-</span> <span class="fu">get_aux</span>(<span class="st">"country_list"</span>) <span class="sc">|&gt;</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(region_code, region, country_code, country_name, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>         africa_split, africa_split_code) <span class="sc">|&gt;</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">region_name =</span> region)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>country_tables <span class="sc">|&gt;</span> </span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(region_code <span class="sc">==</span> <span class="st">"SSA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 48 × 6
   region_code region_name        country_code country_name         africa_split
   &lt;chr&gt;       &lt;chr&gt;              &lt;chr&gt;        &lt;chr&gt;                &lt;chr&gt;       
 1 SSA         Sub-Saharan Africa AGO          Angola               Eastern and…
 2 SSA         Sub-Saharan Africa BDI          Burundi              Eastern and…
 3 SSA         Sub-Saharan Africa BEN          Benin                Western and…
 4 SSA         Sub-Saharan Africa BFA          Burkina Faso         Western and…
 5 SSA         Sub-Saharan Africa BWA          Botswana             Eastern and…
 6 SSA         Sub-Saharan Africa CAF          Central African Rep… Western and…
 7 SSA         Sub-Saharan Africa CIV          Cote d'Ivoire        Western and…
 8 SSA         Sub-Saharan Africa CMR          Cameroon             Western and…
 9 SSA         Sub-Saharan Africa COD          Congo, Dem. Rep.     Eastern and…
10 SSA         Sub-Saharan Africa COG          Congo, Rep.          Western and…
# ℹ 38 more rows
# ℹ 1 more variable: africa_split_code &lt;chr&gt;</code></pre>
</div>
</div>
</section>
<section id="obtain-reference-year-poverty-estimates-and-merge" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="obtain-reference-year-poverty-estimates-and-merge"><span class="header-section-number">4.2</span> Obtain reference-year poverty estimates and Merge</h2>
<p>We then get country-level estimates at the national level for the poverty headcount ratio:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>country_estimates <span class="ot">&lt;-</span> country_estimates <span class="sc">|&gt;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, year, reporting_level, headcount) <span class="sc">|&gt;</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(reporting_level <span class="sc">==</span> <span class="st">"national"</span> <span class="sc">|</span> country_code <span class="sc">==</span> <span class="st">"ARG"</span>) <span class="sc">|&gt;</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1990</span><span class="sc">:</span><span class="dv">2022</span>)) <span class="sc">|&gt;</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">hc =</span> headcount)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And check that they are uniquely identified:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(joyn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'joyn'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:dplyr':

    anti_join, full_join, inner_join, left_join, right_join</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:base':

    merge</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>joyn<span class="sc">::</span><span class="fu">is_id</span>(country_estimates, <span class="fu">c</span>(<span class="st">'country_code'</span>, <span class="st">'year'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Duplicates in terms of `country_code` and `year` </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  copies    n percent
1      1 5550    100%
2  total 5550    100%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>─────────────────────────────────────────────────────── End of is_id() report ──</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>We then merge them to population and country reference tables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>country_estimates <span class="ot">&lt;-</span> country_estimates <span class="sc">|&gt;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(pop_tables, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country_code"</span>, <span class="st">"year"</span>, <span class="st">"reporting_level"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">left_join</span>(country_tables, <span class="at">by =</span> <span class="st">"country_code"</span>) <span class="sc">|&gt;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(country_code, year, reporting_level)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-africa-split-codes-for-afw-and-afe-and-append" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="get-africa-split-codes-for-afw-and-afe-and-append"><span class="header-section-number">4.3</span> Get Africa Split Codes for AFW and AFE and Append</h2>
<p>We want to calculate regional estimates for Eastern and Southern Africa (AFE) and Western and Central Africa (AFW) separately. To do so, we can use the <code>africa_split_code</code> variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>subreg <span class="ot">&lt;-</span> country_estimates <span class="sc">|&gt;</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(africa_split_code <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"AFW"</span>, <span class="st">"AFE"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">region_code =</span> africa_split_code, <span class="co"># Here we substitute the region_code with the respective africa_split_code.</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">subregion =</span> <span class="dv">1</span>, </span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">region_name =</span> africa_split_code)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>subreg <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="at">n=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 11
  country_code  year reporting_level    hc      pop region_code region_name
  &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;           &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;      
1 AGO           1990 national        0.179 11828638 AFE         AFE        
2 AGO           1991 national        0.184 12228691 AFE         AFE        
3 AGO           1992 national        0.202 12632507 AFE         AFE        
4 AGO           1993 national        0.254 13038270 AFE         AFE        
5 AGO           1994 national        0.256 13462031 AFE         AFE        
# ℹ 4 more variables: country_name &lt;chr&gt;, africa_split &lt;chr&gt;,
#   africa_split_code &lt;chr&gt;, subregion &lt;dbl&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>country_estimates_complete <span class="ot">&lt;-</span> country_estimates <span class="sc">|&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(subreg)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Note correspondeces now:</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>country_estimates_complete <span class="sc">|&gt;</span> </span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(region_code, africa_split, africa_split_code) <span class="sc">|&gt;</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
   region_code africa_split                africa_split_code
   &lt;chr&gt;       &lt;chr&gt;                       &lt;chr&gt;            
 1 SSA         Eastern and Southern Africa AFE              
 2 ECA         &lt;NA&gt;                        &lt;NA&gt;             
 3 OHI         &lt;NA&gt;                        &lt;NA&gt;             
 4 LAC         &lt;NA&gt;                        &lt;NA&gt;             
 5 SSA         Western and Central Africa  AFW              
 6 SAS         &lt;NA&gt;                        &lt;NA&gt;             
 7 EAP         &lt;NA&gt;                        &lt;NA&gt;             
 8 MNA         &lt;NA&gt;                        &lt;NA&gt;             
 9 AFE         Eastern and Southern Africa AFE              
10 AFW         Western and Central Africa  AFW              </code></pre>
</div>
</div>
</section>
<section id="calculate-global-poverty-estimates" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="calculate-global-poverty-estimates"><span class="header-section-number">4.4</span> Calculate Global Poverty Estimates</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>global_poverty <span class="ot">&lt;-</span> country_estimates_complete <span class="sc">%&gt;%</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(subregion <span class="sc">!=</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># Removes duplicates of African countries used for subr-egional estimates</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">hc =</span> <span class="fu">weighted.mean</span>(hc, pop, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>            <span class="at">pop =</span> <span class="fu">sum</span>(pop, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">region_code =</span> <span class="st">"WLD"</span>,</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">region_name =</span> <span class="st">"World"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>regional_poverty <span class="ot">&lt;-</span> country_estimates_complete <span class="sc">%&gt;%</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(region_code, region_name, year) <span class="sc">%&gt;%</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">hc =</span> <span class="fu">weighted.mean</span>(hc, pop, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), </span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">pop =</span> <span class="fu">sum</span>(pop, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`summarise()` has grouped output by 'region_code', 'region_name'. You can
override using the `.groups` argument.</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>regional_estimates <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(regional_poverty, global_poverty) <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">hc_own =</span> hc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="compare-with-already-calculated-regioal-aggregates" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="compare-with-already-calculated-regioal-aggregates"><span class="header-section-number">4.5</span> Compare with already calculated regioal aggregates</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>regional_comparison <span class="ot">&lt;-</span> pip_regional <span class="sc">|&gt;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(region_code, year, <span class="at">hc =</span> headcount) <span class="sc">|&gt;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&gt;=</span> <span class="dv">1990</span>) <span class="sc">|&gt;</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">full_join</span>(regional_estimates, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"region_code"</span>, <span class="st">"year"</span>))<span class="sc">|&gt;</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">d_hc =</span> hc<span class="sc">/</span>hc_own)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── JOYn Report ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>  .joyn   n percent
1     x  53   15.1%
2 x &amp; y 297   84.9%
3 total 350    100%</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>────────────────────────────────────────────────────────── End of JOYn report ──</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ℹ Note: Joyn's report available in variable .joyn</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>ℹ Note: Removing key variables region_code and year from region_code,
region_name, year, hc_own, and pop</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>mean_d_hc <span class="ot">&lt;-</span> <span class="fu">mean</span>(regional_comparison<span class="sc">$</span>d_hc, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">round</span>(mean_d_hc) <span class="sc">!=</span> <span class="dv">1</span>) {</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"The mean of d_hc is not approximately 1. Check the merge."</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>} <span class="co"># We're okay!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="calculate-the-international-poverty-line" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Calculate the international poverty line</h1>
<p>The IPL is now derived as the median of the national poverty lines of 28 of the world’s poorest countries, expressed in 2017 PPPs. For convenience, we will make use of an already generated dataset containing headcount ratios for this set of countries. More on the international poverty line (theory and Q&amp;A): <a href="https://www.worldbank.org/en/news/factsheet/2022/05/02/fact-sheet-an-adjustment-to-global-poverty-lines#9">Factseet on Adjustment to the Poverty Line</a>.</p>
<section id="load-data-and-query-pip" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="load-data-and-query-pip"><span class="header-section-number">5.1</span> Load Data and query PIP</h2>
<p>First we load the headcount ratios for the 28 countries:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>npl_data <span class="ot">&lt;-</span> <span class="fu">read_stata</span>(<span class="st">"/Users/giorgia/repos/pip_canazei_notes/material/national_poverty_rates_lic.dta"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we query PIP to derive the poverty line at a given headcount. To do so, we need to use the argument <code>popshare</code>, and loop through (or use <code>{purrr}</code> for vectorized loops) each country and headcount ratio:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>harmonized_npl <span class="ot">&lt;-</span> npl_data <span class="sc">|&gt;</span> </span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">pip_data =</span> <span class="fu">map2</span>(</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">.x =</span> country_code, </span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">.y =</span> headcount_nat, </span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">.f =</span> <span class="sc">~</span> <span class="fu">get_stats</span>(</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">country =</span> .x, </span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">year =</span> <span class="st">"all"</span>, </span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">popshare =</span> .y</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>harmonized_npl_unnested <span class="ot">&lt;-</span> harmonized_npl <span class="sc">|&gt;</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(country_code, year, pip_data) <span class="sc">|&gt;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unnest the fetched data</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(pip_data, <span class="at">names_sep =</span> <span class="st">"."</span>)</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>harmonized_npl_unnested <span class="sc">|&gt;</span> <span class="fu">head</span>(<span class="at">n=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 46
  country_code  year pip_data.region_name  pip_data.region_code
  &lt;chr&gt;        &lt;dbl&gt; &lt;chr&gt;                 &lt;chr&gt;               
1 AZE           2001 Europe &amp; Central Asia ECA                 
2 AZE           2001 Europe &amp; Central Asia ECA                 
3 AZE           2001 Europe &amp; Central Asia ECA                 
4 AZE           2001 Europe &amp; Central Asia ECA                 
5 AZE           2001 Europe &amp; Central Asia ECA                 
# ℹ 42 more variables: pip_data.country_name &lt;chr&gt;,
#   pip_data.country_code &lt;chr&gt;, pip_data.year &lt;dbl&gt;,
#   pip_data.reporting_level &lt;chr&gt;, pip_data.survey_acronym &lt;chr&gt;,
#   pip_data.survey_coverage &lt;chr&gt;, pip_data.welfare_time &lt;dbl&gt;,
#   pip_data.welfare_type &lt;chr&gt;, pip_data.survey_comparability &lt;dbl&gt;,
#   pip_data.comparable_spell &lt;chr&gt;, pip_data.poverty_line &lt;dbl&gt;,
#   pip_data.headcount &lt;dbl&gt;, pip_data.poverty_gap &lt;dbl&gt;, …</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>harmonized_npl_unnested <span class="ot">&lt;-</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>harmonized_npl_unnested <span class="sc">|&gt;</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter and prepare final dataset</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(pip_data.year <span class="sc">==</span> year, </span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>         pip_data.welfare_type <span class="sc">==</span> <span class="st">"consumption"</span>) <span class="sc">|&gt;</span></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    country_code, pip_data.region_code, pip_data.year, pip_data.welfare_time, pip_data.headcount, </span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    pip_data.poverty_line, pip_data.reporting_level, pip_data.welfare_type</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">harm_npl =</span> pip_data.poverty_line) <span class="sc">|&gt;</span> </span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">harm_npl =</span> <span class="fu">as.numeric</span>(harm_npl))</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>harmonized_npl_unnested</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 28 × 8
   country_code pip_data.region_code pip_data.year pip_data.welfare_time
   &lt;chr&gt;        &lt;chr&gt;                        &lt;dbl&gt;                 &lt;dbl&gt;
 1 AZE          ECA                           2001                 2001 
 2 BDI          SSA                           2013                 2014.
 3 BEN          SSA                           2015                 2015 
 4 BFA          SSA                           2014                 2014 
 5 CAF          SSA                           2008                 2008 
 6 COD          SSA                           2012                 2012.
 7 COM          SSA                           2004                 2004 
 8 ETH          SSA                           2015                 2016.
 9 GIN          SSA                           2012                 2012 
10 GMB          SSA                           2015                 2015.
# ℹ 18 more rows
# ℹ 4 more variables: pip_data.headcount &lt;dbl&gt;, harm_npl &lt;dbl&gt;,
#   pip_data.reporting_level &lt;chr&gt;, pip_data.welfare_type &lt;chr&gt;</code></pre>
</div>
</div>
</section>
<section id="calculate-the-international-poverty-line-ipl" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="calculate-the-international-poverty-line-ipl"><span class="header-section-number">5.2</span> Calculate the International Poverty Line (IPL)</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>ipl <span class="ot">&lt;-</span> harmonized_npl_unnested <span class="sc">|&gt;</span> </span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">ipl =</span> <span class="fu">median</span>(harm_npl, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(ipl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualize-harmonized-poverty-lines-by-region" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="visualize-harmonized-poverty-lines-by-region"><span class="header-section-number">5.3</span> Visualize Harmonized Poverty Lines by Region</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(harmonized_npl_unnested, </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>       <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(pip_data.region_code, harm_npl), <span class="at">y =</span> harm_npl, <span class="at">fill =</span> pip_data.region_code)) <span class="sc">+</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_boxplot</span>(<span class="at">outlier.shape =</span> <span class="cn">NA</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> ipl), <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Harmonized National Poverty Lines by Region"</span>,</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="fu">paste</span>(<span class="st">"Median IPL:"</span>, <span class="fu">round</span>(ipl, <span class="dv">2</span>), <span class="st">"2017 PPP dollars"</span>),</span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Region"</span>,</span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Harmonized National Poverty Line (PPP $)"</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R_part_2_files/figure-html/unnamed-chunk-38-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-1-kuznets-curve" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Exercise 1: Kuznets Curve</h1>
<p>We can now move on to more interactive exercises which use PIP data. First, we are going to explore the Kuznets curve hypothesis. The Kuznets curve hypothesis posits that inequality first increases and then decreases as a country develops. The hypothesis is often represented by an <strong>inverted U-shaped curve</strong>.</p>
<p>To do so, we(you) need to:</p>
<ol type="1">
<li><p>Plot the relationship between an inequality metric and log mean welfare.</p></li>
<li><p>Test the relationship by regressing an inequality metric on a 2nd order polynomial of log mean welfare.</p></li>
</ol>
<section id="scatterplot" class="level2" data-number="6.1">
<h2 data-number="6.1" class="anchored" data-anchor-id="scatterplot"><span class="header-section-number">6.1</span> Scatterplot</h2>
<p>Unfold the code to reveal the answer:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load PIP data</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>pip_data <span class="ot">&lt;-</span> <span class="fu">get_stats</span>()</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># filter(welfare_type == "consumption", reporting_level == "national") Does it hold for different types of data?</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot </span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>scatterplot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pip_data, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(mean), <span class="at">y =</span> gini)) <span class="sc">+</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"darkblue"</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span>  </span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">formula =</span> y <span class="sc">~</span> <span class="fu">poly</span>(x, <span class="dv">2</span>), <span class="at">se =</span> <span class="cn">TRUE</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">fill =</span> <span class="st">"pink"</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Exploring the Kuznets Curve Hypothesis"</span>,</span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Relationship between inequality (Gini) and log welfare"</span>,</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Log of Mean Welfare"</span>,</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Gini Coefficient"</span></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>scatterplot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R_part_2_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="regression-check" class="level2" data-number="6.2">
<h2 data-number="6.2" class="anchored" data-anchor-id="regression-check"><span class="header-section-number">6.2</span> Regression Check</h2>
<p>Unfold the code to see the answer:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Regression check</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">lm</span>(gini <span class="sc">~</span> <span class="fu">log</span>(mean)<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span> <span class="fu">I</span>(<span class="fu">log</span>(mean)<span class="sc">^</span><span class="dv">2</span>), <span class="at">data =</span> pip_data)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = gini ~ log(mean)^2 + I(log(mean)^2), data = pip_data)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.198689 -0.053741 -0.009753  0.045945  0.307319 

Coefficients:
                Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)     0.327814   0.010476  31.293   &lt;2e-16 ***
log(mean)       0.077606   0.008401   9.238   &lt;2e-16 ***
I(log(mean)^2) -0.019922   0.001575 -12.651   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.08024 on 2453 degrees of freedom
Multiple R-squared:  0.1431,    Adjusted R-squared:  0.1424 
F-statistic: 204.9 on 2 and 2453 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="6.3">
<h2 data-number="6.3" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">6.3</span> Conclusion</h2>
<ol type="1">
<li><strong>Scatterplot:</strong>
<ul>
<li>Plots the Gini coefficient (inequality) against the log of mean welfare.</li>
<li>Includes a <strong>trendline</strong> modeled using a quadratic regression to check for the inverted U-shape.</li>
</ul></li>
<li><strong>Regression Analysis:</strong>
<ul>
<li>Regresses <strong>Gini</strong> on a 2nd-order polynomial of <strong>log(mean)</strong>: $<span class="math inline">\(Gini = \beta_0 + \beta_1 \cdot \log(mean) + \beta_2 \cdot \log(mean)^2 + \epsilon\)</span>$</li>
<li>The <strong>summary</strong> output will show:
<ul>
<li>Whether the quadratic term (<span class="math inline">\(\beta_2\)</span>) is significant.</li>
<li>If (<span class="math inline">\(\beta_2 &lt; 0\)</span>), it supports the Kuznets hypothesis (inverted U-shape).</li>
</ul></li>
</ul></li>
<li>However: when filtering to consumption/income data only, things are more complex.</li>
</ol>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>scatterplot <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>welfare_type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R_part_2_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="exercise-2-covid-19-impact-on-poverty-and-inequality" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Exercise 2: COVID-19 Impact on poverty and inequality</h1>
<p>For this exercise you will need to:</p>
<ol type="1">
<li><p>Calculate and plot the change in millions of extreme poor by region from 2019 to 2020.</p></li>
<li><p>Calculate and plot the changes in Gini observed from 2019 to 2020 for countries with comparable data during these two years.</p></li>
</ol>
<section id="change-in-millions-of-extreme-poor" class="level2" data-number="7.1">
<h2 data-number="7.1" class="anchored" data-anchor-id="change-in-millions-of-extreme-poor"><span class="header-section-number">7.1</span> Change in Millions of Extreme Poor</h2>
<p>First, load, the data at the regional level (<code>get_wb()</code>) and generate the metric needed (change in poverty, in millions). Unfold the code to see the answer:</p>
<p>Next, plot the data. Again, unfold the code to see the answer:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot change in number of poor (in millions) by region</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>poverty_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(wb_data, <span class="fu">aes</span>(<span class="at">x =</span> region_name, <span class="at">y =</span> changeinpoor <span class="sc">/</span> <span class="dv">10</span><span class="sc">^</span><span class="dv">6</span>, <span class="at">fill =</span> region_name)) <span class="sc">+</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Change in Extreme Poverty (2019–2020)"</span>,</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Change in the number of extreme poor (millions) by region"</span>,</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Region"</span>,</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Change in Millions"</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">"none"</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>poverty_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R_part_2_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="change-in-gini-coefficient" class="level2" data-number="7.2">
<h2 data-number="7.2" class="anchored" data-anchor-id="change-in-gini-coefficient"><span class="header-section-number">7.2</span> Change in Gini Coefficient</h2>
<p>First, download the data at the country level <code>get_stats()</code> and generate the needed metrics (change in Gini). Unfold the code to see the answer:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load data for Gini index</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>df_gini <span class="ot">&lt;-</span> <span class="fu">get_stats</span>() <span class="sc">|&gt;</span> </span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>((year <span class="sc">==</span> <span class="dv">2019</span> <span class="sc">|</span> year <span class="sc">==</span> <span class="dv">2020</span>) <span class="sc">&amp;</span> reporting_level <span class="sc">==</span> <span class="st">"national"</span>) <span class="sc">|&gt;</span> <span class="co"># Select years and national data</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(country_code, welfare_type, comparable_spell) <span class="sc">|&gt;</span> <span class="co"># Group by country and welfare type</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">n</span>() <span class="sc">==</span> <span class="dv">2</span>) <span class="sc">|&gt;</span> <span class="co"># Keep only countries with data in both years</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(country_code, year) <span class="sc">|&gt;</span> <span class="co"># Ensure sorted order</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">ginichange =</span> gini <span class="sc">-</span> <span class="fu">lag</span>(gini)) <span class="sc">|&gt;</span> <span class="co"># Calculate change in Gini</span></span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2020</span>) <span class="co"># Keep only 2020 data for plotting</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Next, plot the data. Unfold the code to see the answer:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot change in Gini index by country</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>gini_plot <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(df_gini, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(country_name, <span class="sc">+</span> ginichange), <span class="at">y =</span> ginichange <span class="sc">*</span> <span class="dv">100</span>, <span class="at">fill =</span> region_name)) <span class="sc">+</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Change in Gini Index (2019–2020)"</span>,</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Change in inequality (Gini points) for countries with comparable data"</span>,</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Country"</span>,</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Change in Gini Points"</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">14</span>) <span class="sc">+</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">face =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>gini_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="R_part_2_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>